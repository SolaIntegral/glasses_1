# 2025-11-09 不具合調査・対応計画

## 目的
アプリ全体で頻発しているログイン・ログアウト関連の遅延／強制ログアウト、およびプロフィール保存時のエラー、MTGリンクの固定化等について、原因調査と恒久的な対策方針を整理する。

## 対応項目（要件整理）

1. **ログイン遅延の解消**
   - 主にスマホ環境で、ID／パスワード入力後にログイン完了まで数分かかる事象が発生。
   - 対処の流れ
     1. 実機（iOS Safari／Android Chrome）で現象再現を試み、ログイン開始〜ダッシュボード表示までのタイムスタンプを取得。
     2. `hooks/useAuth.tsx`（`signIn` / `setSessionId` / `router.replace` など）の各段階に計測ログを追加。
     3. Firebase Functions 側のカスタムトークン発行 API の応答時間を計測し、Cloud Logging にも同様のトレースを残す。
     4. 遅延箇所がフロント側の状態遷移か、バックエンド API か、あるいはネットワーク要因かを切り分け。
     5. 原因に応じて改善策を実装（例：リトライ間隔の調整、セッションキャッシュの見直し、API 応答短縮など）。
   - 再発監視
     - ログイン処理の詳細なトレースログを Firestore の `appLogs`（仮）へ保存し、遅延発生時の要因分析を容易にする。

2. **意図しないログアウトの解消**
   - ページ遷移やタブ切り替え時にセッションが切れてログアウト状態になる事例が多数。
   - 対処の流れ
     1. ブラウザの Storage（LocalStorage / Cookies）に保存しているセッション情報（`sessionId` など）が消えるタイミングを把握。
     2. `useAuth` 内の `auth.onAuthStateChanged` や `listenToSession` 相当の購読処理で想定外の `null` が返っていないか検証。
     3. `router.replace('/auth/login')` を実行している箇所を洗い出し、ガード条件を細かくログに記録して再現時の導線を特定。
     4. Firebase Functions / Firestore でセッションタイムアウト設定や集約処理がないかを確認し、必要なら延長やリフレッシュ処理を実装。
     5. バックグラウンド遷移やページ再読込でもセッションが保持されることを実機で確認。
   - 明示的に「ログアウト」ボタンを押した場合以外はセッションが切れないよう修正。
   - ログアウトやセッション切断イベントも詳細ログとして記録し、原因分析に活用。

3. **監視ログ基盤の整備**
   - 目的：エラーや遅延を迅速に検知し、ユーザー行動を把握できるようにする。
   - ログデータ設計
     - コレクション案：`appLogs`
     - フィールド例：`type`（login/logout/update/profile/booking など）、`userId`, `role`, `timestamp`, `clientType`（web/ios/android）、`ipHash`, `metadata`（JSON 形式で詳細を格納）
     - PII 対策として IP はハッシュ化、端末情報も必要最低限に。
   - ログ収集
     - フロントエンドからのログ送信モジュールを共通化（初期は Firestore 直書き、必要に応じ Cloud Functions 経由に拡張）。
     - Firebase Functions でも重要イベント（カレンダー連携失敗、通知失敗など）を Cloud Logging に出力し、必要に応じて Firestore に転送。
   - ログ閲覧 UI
     - 管理画面に「ログ管理」ページを新設し、タブで用途別に表示。
       - `ログイン履歴`：ユーザー・端末種別・実行結果・処理時間を表示。
       - `ログアウト履歴`：強制ログアウト時のトリガー、イベントの前後関係を確認。
       - `プロフィール編集履歴`：講師プロフィールの更新有無を追跡。
       - `予約状況/講師空枠`：ログデータに基づく集計レポートを表示（下記項目 4 と連携）。

4. **予約状況可視化**
   - 目的：システム全体の稼働状況（生徒の予約・講師の空き枠）を一目で把握し、抜け漏れを防ぐ。
   - 生徒向けレポート
     - Firestore の `bookings` コレクションから直近の予約日を集計（例：過去 30 日以内に予約がない生徒をハイライト表示）。
     - 生徒マスタ（`users` + `students`）と結合し、表示名・所属なども併記。
     - CSV エクスポートやフィルタリング（学年／担当講師など）も将来的に実装を検討。
   - 講師向けレポート
     - `availableSlots` コレクションから未来日で予約可能な枠数、最終更新日時を集計。
     - 空枠が一定以下の講師を上位に表示し、管理者がフォローしやすいようにする。
   - UI 案
     - 管理画面の「ログ管理」ページ内に `予約状況` タブを設け、一覧＋簡易グラフ（棒グラフ／トレンド）を表示。
     - 生徒未予約リストと講師空枠リストを切り替え表示、または上下二段構成で配置。

5. **MTGリンク仕様の見直し**
   - 目的：自動議事録ツール（tl;dv 等）がホスト不在でも議事録取得できるようにする。
   - 現状：講師ごとに固定 `meetingUrl` を設定し、予約時にコピーして利用。
   - 調査メモ：
     - tl;dv は Google カレンダーに招待されたイベントへ自動参加する方式で、定期ミーティング（同一リンクの繰り返し）にも対応している。新規リンク発行は必須ではない。
     - 対象カレンダーが tl;dv 用アカウントであれば、追加で招待を行わなくてもイベント作成だけで自動参加できる。
     - 別アカウントがイベントを登録する場合は、そのカレンダーへの編集権限を持っていることを確認。
   - 案：
     - (A) 予約作成時に Google Calendar から Meet リンクを都度生成し、予約・通知・カレンダーへ反映。（tl;dv が毎回別リンクを必要とする運用に備える場合）
     - (B) 従来通り講師固定リンクを使用しつつ、カレンダーイベントに tl;dv を自動招待する運用を整備（新規リンク不要なため実装コストは低い）。
   - **要確認事項**：実運用として「参加者を招待し忘れない仕組み」が必要か、開催者不在時に tl;dv の自動入室が問題なく成功しているかを検証する。

6. **プロフィール保存時の `undefined` エラー**
   - 空欄入力のまま保存すると `updateDoc` が `undefined` を受け付けずエラー。
   - 対処案：
     - 保存処理で `sanitizeProfilePayload()` のようなユーティリティを挟み、`undefined` を `null` またはフィールド削除に変換。
     - `education` / `workHistory` 配列内のオブジェクトについても同様にサニタイズし、空文字のみのレコードは除外。
     - バリデーション結果を UI 上にフィードバックし、必要に応じて任意項目である旨のメッセージを表示。

7. **スマホでの操作遅延・不安定さ**
   - 主に 1. と 2. に付随する問題と想定。
   - 計測・検証
     - Lighthouse モバイルモード、Chrome DevTools Performance、Safari Web Inspector を用いて初期描画／インタラクションの遅延箇所を計測。
     - ネットワーク速度を 3G/4G に制限した状態でログイン〜ダッシュボード表示までの処理時間を比較。
   - 改善候補
     - クリティカルでないスクリプトの遅延読み込み、画像の遅延読み込み（lazy loading）。
     - React レンダリングのメモ化、不要な再レンダリング抑制（`useMemo`, `useCallback`）。
     - API リクエストのバッチ化やキャッシュ活用による問い合わせ回数削減。

## 初期調査計画

1. **ログ基盤整備（優先）**
   - 共通ロギングユーティリティを作成し、クライアント／Firebase Functions の双方から Firestore（例：`appLogs` コレクション）へ送信。
   - ログスキーマ（例：`type`, `userId`, `role`, `timestamp`, `context`, `metadata`）の定義。

2. **ログイン遅延／意図しないログアウトの調査**
   - `useAuth` 周辺の処理フローとストレージ管理（sessionId, token など）を確認。
   - 重要イベントにログ追加：`signIn` 開始／成功／失敗、`authStateChanged` 発火、`router.replace` でのリダイレクト、`signOut` 実行など。
   - 実機 or エミュレータで再現試験し、端末／ネットワーク条件も記録。

3. **ログ閲覧 UI の設計**
   - 管理向け `app/admin/logs/page.tsx`（仮称）を新規作成。
   - タブ構成：`ログイン履歴`, `ログアウト履歴`, `プロフィール変更`, `予約状況`, `講師空枠`.
   - 予約状況タブでは以下を表示する構成を想定。
     - 生徒一覧＋直近予約日時＋「未予約」の強調表示。
     - 講師の空き時間登録状況（空枠数・最終更新日など）。

4. **MTGリンク仕様調査**
   - tl;dv の要件確認：毎回新規 Meet 必須か、固定リンク可か、不特定ホストでも記録可能か。
   - (A) 案採用時は、Google Calendar API にて `conferenceData` を生成し、予約保存後に Firestore の `meetingUrl` を更新するフローを設計。
   - 既存の Functions (`onCreateBooking` など) へ影響が大きいため、要件確定後にスケジュール策定。

5. **プロフィール保存エラー対策**
   - `app/instructor/profile/page.tsx` の保存処理で `undefined` を排除。
   - `education` / `workHistory` 配列内の空フィールドを `null` または削除するユーティリティ実装。

## 既知のリスク・留意点

- ログの保存量が増えるため、Firestore 料金およびクエリ性能を考慮し、期間限定 or ページング対応を検討する。
- Google Meet の自動生成を行う場合は、サービスアカウントへ `calendar.events` の権限付与があるか事前確認。
- ログイン遅延の原因として、認証処理の再試行やリダイレクトループ、ネットワークタイムアウトなど複数要因が考えられるため、調査結果をもとに段階的に対策。

## オープンな疑問点（要ヒアリング）

1. tl;dv で議事録を自動取得するために「毎回新しい Google Meet リンク」が必須か？
   - 必須の場合、Google Calendar API での自動生成を実装する（工数大）。
   - 任意の場合は現状の講師固定リンクでも可。ただし録音対象の部屋をどう切り替えるか確認したい。

2. ログ閲覧ページのアクセス権限
   - 管理者のみ閲覧で問題ないか。講師側にも自分のログ閲覧が必要か。

3. ログの保持期間・バックアップ
   - 無期限で保持するか、一定期間でアーカイブするか方針が必要。

4. スマホでの再現環境
   - 主要な端末／OS／ブラウザ（例：iPhone Safari, Android Chrome）の優先度。

不明点が解消し次第、詳細タスク・スケジュールを追加予定。


